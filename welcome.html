<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Index of Dissent — All objects</title>
  <link rel="stylesheet" href="style.css?v=2" />
  <style>
    /* Minimal, focused gallery layout */
  :root{--site-gutter:24px;--bottom-nav-height:64px}
  html,body{height:100%;margin:0}
  main{min-height:100vh;padding:var(--site-gutter);box-sizing:border-box; padding-bottom:calc(var(--site-gutter) + var(--bottom-nav-height) + env(safe-area-inset-bottom));}
    #infinite-gallery{
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(200px,1fr));
      gap:16px;
      align-items:start;
      max-width:1400px;
      margin:0 auto;
    }
    .card-link{display:block;color:inherit;text-decoration:none}
    .card{background:#fff;overflow:hidden;display:block;position:relative;border:0}
    .card img{width:100%;height:260px;object-fit:cover;display:block;background:#f4f4f4}
  .lazy-img{opacity:0;transition:opacity .28s ease}
  .lazy-img.img-loaded{opacity:1}
  /* top and bottom sentinels used to detect scroll edges */
  #gallery-sentinel, #gallery-sentinel-top{height:1px;pointer-events:none}
    @media (max-width:520px){ .card img{height:160px} }
   /* Controls bar and list view styles. The controls bar is hidden by default
     and is shown when the Search toggle is activated. */
    .controls-bar{
      display:none; /* hidden until Search is pressed */
      gap:12px;align-items:center;flex-wrap:wrap;justify-content:flex-start;padding:10px;background:#fff;box-shadow:0 8px 24px rgba(0,0,0,0.12);width:320px;box-sizing:border-box}
    .controls-bar.visible{display:flex;flex-direction:column}
    .view-toggle{display:inline-flex;border:1px solid rgba(0,0,0,0.08);border-radius:6px;overflow:hidden}
    .view-toggle button{all:unset;padding:8px 12px;cursor:pointer;font-weight:600}
    .view-toggle button[aria-pressed="true"]{background:#000;color:#fff}
    .controls-inputs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .controls-inputs input[type="search"],.controls-inputs select{padding:8px 10px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);font-size:15px}
    #list-view{max-width:1400px;margin:0 auto;display:none; height: calc(100vh - 120px); box-sizing:border-box}
    .list-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
  /* List view: tags-only rows (no photos). */
  /* Make the list area horizontally scrollable and prevent vertical scrolling
     when the site is in list view. Children will be laid out in a single
     horizontal row so the user can scroll sideways through results. */
  #list-grid{
    display:flex;
    flex-wrap:nowrap;
    gap:16px; 
    overflow-x:auto;
    overflow-y:hidden;
    padding-bottom: calc(var(--bottom-nav-height));
    -webkit-overflow-scrolling: touch;
    width: 100vw;
    align-content: flex-start;
  }
  .list-row{background:#fff;padding:10px 14px;border-radius:8px;text-decoration:none;color:inherit;min-width:260px;flex:0 0 auto}
  .list-row h3{margin:0 0 6px 0;font-size:18px}
  .list-row .tags{margin-top:6px}
  .list-card{display:none}
    @media (max-width:520px){ .list-card img{height:120px} }
   /* Tag chips for list view: four kinds with distinct colors */
  /* Tags: arrange into 8 rows and scroll horizontally across columns */
  .tags{
    --tag-row-height:44px;
    display:grid;
    grid-auto-flow: column; /* fill rows first, then create new columns */
    grid-template-rows: repeat(10, var(--tag-row-height)); /* 8 rows */
    grid-auto-columns: max-content; /* columns sized to their content */
    /* gap:16px 20px; row-gap then column-gap */
    margin:12px 0;
    /* include padding in height calculations so scroll height is correct */
    box-sizing: border-box;
    padding:12px 8px  calc(var(--bottom-nav-height) + 12px); /* keep extra bottom padding to clear fixed nav */
    /* limit visible area to 8 rows but subtract bottom-nav so last row isn't hidden 
    (--bottom-nav-height) - env(safe-area-inset-bottom));
    overflow-x:auto; /* horizontal scroll */
    overflow-y:hidden;
    -webkit-overflow-scrolling:touch;
  }
  /* Make tag tiles larger with more padding */
  .tag{display:inline-block;padding:10px 16px;font-family:'Lekton-Bold';font-size:22px;color:#000000;align-self:center}
  /* Give a playful 'scattered' look by rotating some tags a little */
  .tags .tag:nth-child(5n+1){transform:rotate(-6deg) translateY(-2px)}
  .tags .tag:nth-child(5n+2){transform:rotate(4deg) translateY(0)}
  .tags .tag:nth-child(5n+3){transform:rotate(-3deg) translateY(2px)}
  .tags .tag:nth-child(5n+4){transform:rotate(2deg) translateY(-1px)}
  .tags .tag:nth-child(5n+5){transform:rotate(0deg)}
  /* Smooth transform on hover/focus */
  .tags .tag{transition:transform .18s ease}
  .tags .tag:focus, .tags .tag:hover{transform:translateY(-4px) scale(1.02)}
  /* horizontal scrollbar styling */
  .tags::-webkit-scrollbar{height:10px}
  .tags::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.12);border-radius:6px}
  .tag.name{background:#fdf217}    /* blue */
  .tag.country{background:#599b55} /* green */
  .tag.type{background:#f76f54}    /* orange */
  .tag.cause{background:#3e75b3}   /* red */
  .tag.clickable-tag{cursor:pointer;opacity:0.95}
  .tag.clickable-tag:hover{filter:brightness(0.95);transform:translateY(-1px)}
  .tag.active{box-shadow:0 0 0 3px rgba(0,0,0,0.06) inset}
  /* List controls: search + kind toggles (appears at top of #list-view) */
  #list-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  #list-controls .list-search{flex:1;min-width:160px;padding:8px 10px;;background:transparent;border:2px solid #000;font-size:15px}
  #list-controls .list-search::placeholder{color:rgba(255, 255, 255, 0.45)}
  .tag-toggles{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  /* Make the tag-toggle labels minimal (no background or border). The checkbox
     itself becomes the visible affordance: a black square with a white check when
     checked. */
  .tag-toggle{display:inline-flex;align-items:center;gap:8px;background:transparent;padding:6px 10px;;border:1;cursor:pointer;font-size:13px;color:#000000}
  /* Keep the active state minimal too: transparent background and black text */
  .tag-toggle.active{background:transparent;color:#000;border-color:transparent;box-shadow:none}
  .tag-toggle input{
    -webkit-appearance:none;appearance:none;
    display:inline-block;width:18px;height:18px;margin-right:8px;vertical-align:middle;cursor:pointer;border:0;background:transparent;box-shadow:none;
    background-repeat:no-repeat;background-position:center;background-size:12px;
  }
  /* When checked, render a solid black box with a white checkmark (inline SVG). */
  .tag-toggle input:checked{
    
    background-image:url("data:image/svg+xml;utf8,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%2024%2024%22%3E%3Cpath%20fill=%22%23fff%22%20d=%22M20.285%206.708l-11.39%2011.39-5.18-5.18%201.414-1.414%203.766%203.766%209.976-9.976z%22/%3E%3C/svg%3E");
  }
  /* keyboard focus visible state */
  .tag-toggle input:focus{outline:2px solid rgba(0,0,0,0.12);outline-offset:2px}
  .tag-toggle.active{background:#000000;color:#fff;border-color:transparent}
  /* Photo results grid used when a tag is clicked - Masonry layout */
  .photo-results-grid{
    column-count: 4;
    column-gap: 10px;
    padding: 12px;
    width: 100%;
    box-sizing: border-box;
  }
  /* Override #list-grid flex layout when showing photo results */
  #list-grid:has(.photo-results-grid),
  #list-grid.showing-photos{
    display: block;
    flex-wrap: unset;
    overflow-x: visible;
    overflow-y: auto;
    width: 100%;
  }
  .photo-result{
    display: inline-block;
    width: 100%;
    margin-bottom: 10px;
    break-inside: avoid;
    -webkit-column-break-inside: avoid;
    overflow: hidden;
  }
  .photo-result img{
    width: 100%;
    height: auto; /* Preserve aspect ratio */
    display: block;
    background: #f4f4f4;
    border-radius: 0; /* Sharp corners */
  }
  @media (max-width:768px){
    .photo-results-grid{
      column-count: 3;
    }
  }
  @media (max-width:520px){
    .photo-results-grid{
      column-count: 2;
    }
  }
  /* Scattered list view: absolutely-positioned card tiles inside the list area */
  .scatter-results{position:relative;min-height:480px;padding:12px}
  .scatter-results .scatter-item{position:absolute;width:200px;background:#fff;overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,0.08);text-decoration:none;color:inherit;display:block}
  .scatter-results .scatter-item img{width:100%;height:140px;object-fit:cover;display:block;background:#f4f4f4}
  @media (max-width:520px){ .scatter-results .scatter-item{width:140px} .scatter-results .scatter-item img{height:100px} }
  /* Masonry layout for tag-search results */
  .masonry{column-width:240px;column-gap:16px;padding:8px}
  .masonry-item{display:inline-block;width:100%;margin:0 0 16px;break-inside:avoid;box-sizing:border-box;overflow:hidden;text-decoration:none;color:inherit}
  .masonry-item img{width:100%;height:auto;display:block;object-fit:cover}
  @media (max-width:520px){ .masonry{column-width:140px} }
  /* Clickable names list shown when tag-originated list is displayed */
  .names-list{display:block;background:transparent;padding:8px 12px;margin-bottom:8px}
  .names-list-item{display:block;padding:8px 10px;color:inherit;text-decoration:none;border:1px solid rgba(0,0,0,0.04);margin-bottom:6px;background:#fff}
  .names-list-item:hover{background:#000;color:#fff}
  /* Result mode toggle and search helper */
  .result-mode-toggle{display:inline-flex;border:1px solid rgba(0,0,0,0.08);overflow:hidden}
  .result-mode-toggle button{all:unset;padding:8px 12px;cursor:pointer;font-weight:700;font-size:14px;display:inline-flex;align-items:center;justify-content:center}
  .result-mode-toggle button[aria-pressed="true"]{background:#C00E88;color:#fff}
  #clear-search{background:#fff}
  #match-count{padding-left:6px}
  /* Main horizontal navigation (Explore / Search / List / About) */
  .main-nav{display:flex;align-items:center;box-sizing:border-box;width:100%;background:var(--site-bg, #f0f0f0);position:fixed;left:0;right:0;bottom:0;z-index:2400;height:var(--bottom-nav-height);padding-bottom:env(safe-area-inset-bottom);backdrop-filter:blur(4px);}
  /* inner container holds the nav items and renders the horizontal line at 90% viewport width */
  .main-nav .nav-inner{width: 95vw;max-width:1500px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;box-sizing:border-box;position:relative;height:100%;border-top:2px solid #000}
  .main-nav .nav-inner .nav-item{flex:1 1 0;text-align:center;padding:8px 10px 6px;position:relative;text-decoration:none;color:inherit;font-family:'Blur Light',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;font-size:30px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
  /* vertical dividers between items (not after last) */
  /* Position divider so it begins at the same height as the horizontal line on .nav-inner
    nav-inner has padding-top:6px, so setting top:-6px pulls the divider up to the line. */
  .main-nav .nav-inner .nav-item:not(:last-child)::after{content:'';position:absolute;right:0;top:-7px;bottom:6px;width:2px;background:#000}
  /* Active nav item uses Blur Bold */
  .main-nav .nav-inner .nav-item.active{font-family:'Blur Bold','Blur Medium',sans-serif;font-weight:700}
    /* About sliding panel (hidden off-canvas bottom -> slides up) */
    .about-panel{
      position:fixed;left:0;right:0;bottom:var(--bottom-nav-height);z-index:2500;transform:translateY(120%);transition:transform .45s cubic-bezier(.2,.9,.2,1);background:transparent;max-height:82vh;overflow:auto;padding:36px 24px 48px;box-sizing:border-box;pointer-events:auto}
  .about-panel.open{transform:translateY(-10vh)}
    .about-panel .about-inner{max-width:1100px;margin:0 auto}
  .about-panel .about-text{font-family:'Lekton-Bold','Lekton-Regular',sans-serif;font-weight:700;font-size:40px;line-height:1.04;color:#000;margin:0;text-transform:uppercase}
    .about-panel .about-close{position:absolute;right:12px;top:8px;border:0;background:transparent;font-size:36px;line-height:1;padding:6px 10px;cursor:pointer}
    @media (max-width:520px){ .about-panel{padding:18px 14px 28px} .about-panel .about-text{font-size:22px} }
  </style>
</head>
<body>
  <div class="site-brand">Index of<br>Dissent</div>
  <style>
    /* Site brand fixed top-left with no background; per-letter overlap effect */
    .site-brand{
      position:fixed;
      left:18px;
      top:12px;
      z-index:2200;
      font-family: 'Blur Light', 'Blur Regular', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size:50px;
      line-height:0.9;
      padding:6px 0; /* no background, keep small padding */
      color:#000;
      transition: color .12s ease, transform .12s ease;
      pointer-events: none; /* allow clicks to pass through to gallery */
      white-space: pre-line;
    }
    /* When the site is in 'list view' we want the brand to participate in normal
       document flow so the list can sit below it. Toggle a class on <body>
       (see js/welcome.js) and this rule will switch the brand to static
       positioning so it occupies space above the list. */
    body.list-view .site-brand{
      position:static;
      left:auto; top:auto;
      z-index: auto;
      pointer-events: auto;
      display:block;
      margin-bottom: 12px;
      /* align with main content padding / search box which uses --site-gutter */
      margin-left: var(--site-gutter);
      /* ensure it doesn't overflow on very narrow screens */
      max-width: calc(100% - (var(--site-gutter) * 1));
      transform: none;
    }
    /* Individual character spans so we can toggle color per-letter */
  .site-brand .brand-char{ display:inline-block; will-change:transform,color,opacity; transition: color .08s ease, transform .08s cubic-bezier(.2,.8,.2,1), opacity .08s ease; color: #000; transform: translateZ(0); }
  .site-brand .brand-char.overlap{ color: #fff; text-shadow: 0 0 6px rgba(0,0,0,0.45); transform: translateY(-2px) scale(1.02); opacity: 0.98; }
    /* smaller on small screens */
    @media (max-width:520px){ .site-brand{ font-size:36px; left:12px; top:8px; } }
  </style>
  <main>
    <!-- Main navigation: Explore / Search / List / About -->
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <div class="nav-inner">
        <a href="#" class="nav-item active" data-action="explore">Explore</a>
        <!-- Removed the old Search button; renamed List -> Search and keep it opening the List view -->
        <a href="#" class="nav-item" data-action="search">Search</a>
        <a href="about.html" class="nav-item" data-action="about">About</a>
      </div>
    </nav>
    <!-- Controls: view toggle, search, filters -->
    <div class="controls-bar" role="region" aria-label="View and filter controls">
      <div class="view-toggle" role="tablist" aria-label="View toggle">
        <button id="btn-gallery" aria-pressed="true" type="button">Gallery</button>
        <button id="btn-list" aria-pressed="false" type="button">List</button>
      </div>
      <div class="controls-inputs">
        <label for="search-input" class="sr-only">Search</label>
        <input id="search-input" type="search" placeholder="Search by name or description" aria-label="Search" />
        <select id="filter-type" aria-label="Filter by type"><option value="">Type (all)</option></select>
        <select id="filter-country" aria-label="Filter by country"><option value="">Country (all)</option></select>
        <select id="filter-cause" aria-label="Filter by cause"><option value="">Cause (all)</option></select>
      </div>
    </div>

  <div id="gallery-sentinel-top" aria-hidden="true"></div>
  <section id="infinite-gallery" aria-label="All objects gallery"></section>
  <div id="gallery-sentinel" aria-hidden="true"></div>
    <!-- List view (hidden by default) -->
    <section id="list-view" aria-label="List of objects">
      <!-- list-level filters: search tags and toggle kinds -->
      <div id="list-controls" aria-hidden="false">
        <input id="list-search" class="list-search" type="search" placeholder="Search tags..." aria-label="Search tags" />
        <div class="result-mode-wrap" style="display:inline-flex;align-items:center;gap:8px;margin-left:8px">
            <!-- images/list toggle removed: default to list view when opening search -->
            <button id="clear-search" type="button" title="Clear search" style="display:none;padding:6px 10px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer">Clear</button>
            <span id="match-count" style="font-size:13px;color:#333;min-width:64px;display:none"></span>
          </div>
        <div class="tag-toggles" role="toolbar" aria-label="Tag kinds">
          <label class="tag-toggle active" data-kind="name"><input type="checkbox" data-kind="name" checked />Names</label>
          <label class="tag-toggle active" data-kind="country"><input type="checkbox" data-kind="country" checked />Countries</label>
          <label class="tag-toggle active" data-kind="type"><input type="checkbox" data-kind="type" checked />Types</label>
          <label class="tag-toggle active" data-kind="cause"><input type="checkbox" data-kind="cause" checked />Causes</label>
        </div>
      </div>
      <div id="list-grid" class="list-grid"></div>
    </section>
    <noscript>
      <p>Please enable JavaScript to view the gallery.</p>
    </noscript>
  </main>

  <!-- About sliding panel -->
  <div id="about-panel" class="about-panel" aria-hidden="true" role="dialog" aria-label="About this catalogue">
    <button class="about-close" aria-label="Close About">×</button>
    <div class="about-inner">
      <p class="about-text">THIS CATALOGUE DOCUMENTS COMMON, EVERYDAY OBJECTS—RIBBONS, SHIELDS, BLANK PAGES—THAT HAVE BEEN REPU RPOSED AS SYMBOLS OF PROTEST. EACH ITEM GAINS POLITICAL POWER ONLY THROUGH USE, TRANSFORMING INTO A TOOL FOR NOISE, VISIBILITY, OR DEFIANCE.</p>
    </div>
  </div>

  <!-- Floating toggle removed in favor of the main horizontal nav -->
  <script src="js/infinite-gallery.js"></script>
  <script src="js/welcome.js"></script>
  <script>
  (function(){
  // images/list mode buttons removed; default behavior will use 'list' mode
  const clearBtn = document.getElementById('clear-search');
  const matchCount = document.getElementById('match-count');
  const searchInput = document.getElementById('list-search');
  // list-controls element (original, kept inside #list-view)
  const listControls = document.getElementById('list-controls');
  const galleryContainer = document.getElementById('infinite-gallery');

  // helper to update all match-count and clear buttons (original + any clones)
  function updateMatchUI(count){
    const clears = Array.from(document.querySelectorAll('#clear-search'));
    const matches = Array.from(document.querySelectorAll('#match-count'));
    if(count > 0){ clears.forEach(c=> c.style.display='inline-block'); matches.forEach(m => { m.style.display='inline-block'; m.textContent = count + ' matches'; }); }
    else { matches.forEach(m => { m.style.display='inline-block'; m.textContent = '0 matches'; }); }
  }

  function clearAllSearchInputs(){
    const inputs = Array.from(document.querySelectorAll('.list-search'));
    inputs.forEach(i=> i.value = '');
  }

  function removeControlsClone(){
    const existing = document.getElementById('list-controls-clone');
    if(existing && existing.parentNode) existing.parentNode.removeChild(existing);
  }

  function createControlsClone(){
    if(!listControls || document.getElementById('list-controls-clone')) return null;
    // deep clone markup
    const clone = listControls.cloneNode(true);
    // remove top-level id to avoid duplicate id collisions; keep inner ids so UI selectors still work
    clone.id = 'list-controls-clone';
    // insert before gallery so it appears above
    document.body.insertBefore(clone, galleryContainer);
    clone.style.display = 'flex';

    // wire clone's inner controls to trigger image searches
    const cloneSearch = clone.querySelector('.list-search');
    const cloneKindToggles = Array.from(clone.querySelectorAll('.tag-toggle')) || [];
    const cloneClear = clone.querySelector('button[title="Clear search"]') || clone.querySelector('#clear-search');

    // debounce re-use (single timer for whole page)
    let localTimer = null;
    if(cloneSearch){
      cloneSearch.addEventListener('input', function(e){
        const q = e.target.value || '';
        clearTimeout(localTimer);
        localTimer = setTimeout(async ()=>{
          await doImageSearch(q);
        }, 220);
      });
    }

    cloneKindToggles.forEach(t => {
      t.addEventListener('click', async ()=>{ await doImageSearch((cloneSearch && cloneSearch.value) || (searchInput && searchInput.value) || ''); });
      const cb = t.querySelector('input[type="checkbox"]');
      if(cb) cb.addEventListener('change', async ()=>{ await doImageSearch((cloneSearch && cloneSearch.value) || (searchInput && searchInput.value) || ''); });
    });

    if(cloneClear){
      cloneClear.addEventListener('click', async ()=>{
        if(window.infiniteGallery && typeof window.infiniteGallery.clearFilter === 'function') await window.infiniteGallery.clearFilter();
        // clear UI everywhere
        removeControlsClone();
        clearAllSearchInputs();
        updateMatchUI(0);
      });
    }

    return clone;
  }

    async function doImageSearch(q){
      // compute which tag kinds are currently enabled (name, country, type, cause)
      const toggles = Array.from(document.querySelectorAll('#list-controls .tag-toggle')) || [];
      const allowedKinds = toggles.filter(t => t.classList.contains('active')).map(t => t.dataset.kind).filter(Boolean);
      if(!window.infiniteGallery || typeof window.infiniteGallery.filterByQuery !== 'function'){
        // fallback: show/hide existing cards by alt text
        const gallery = document.getElementById('infinite-gallery'); if(!gallery) return;
        const cards = Array.from(gallery.querySelectorAll('a.card-link'));
        const qq = (q||'').trim().toLowerCase(); let matched = 0;
        cards.forEach(a=>{
          const img = a.querySelector('img');
          const txt = (img && (img.alt||'')) + ' ' + (a.dataset && (Object.values(a.dataset)||[]).join(' '));
          const ok = !qq || (txt||'').toLowerCase().includes(qq);
          a.style.display = ok ? '' : 'none'; if(ok) matched++;
        });
        updateMatchUI(matched);
        return matched;
      }
      const count = await window.infiniteGallery.filterByQuery(q, allowedKinds);
      updateMatchUI(count);
      return count;
    }

  // image/list mode UI removed — no per-result toggle. Default mode will be 'list'.

    // updated setMode to duplicate controls instead of moving them
    function setMode(m){
      document.body.dataset.resultMode = m;
      if(btnImages) btnImages.setAttribute('aria-pressed', m==='images');
      if(btnList) btnList.setAttribute('aria-pressed', m==='list');
      // show/hide UI
      if(m === 'images'){
        try{ galleryContainer.style.display='block'; document.getElementById('list-view').style.display='none'; }catch(e){}
        try{
          // create a clone of the list-controls and insert above the gallery
          createControlsClone();
        }catch(e){ console.warn('createControlsClone failed', e); }
      } else {
        try{ galleryContainer.style.display='none'; document.getElementById('list-view').style.display='block'; }catch(e){}
        // remove any clone so original layout remains intact
        try{ removeControlsClone(); }catch(e){}
      }
    }

    // Clear button behavior: affect both modes
    const allClearButtons = Array.from(document.querySelectorAll('#clear-search'));
    allClearButtons.forEach(cb => cb.addEventListener('click', async ()=>{
      if(document.body.dataset.resultMode === 'images'){
        if(window.infiniteGallery && typeof window.infiniteGallery.clearFilter === 'function') await window.infiniteGallery.clearFilter();
        // clear UI everywhere
        clearAllSearchInputs();
        updateMatchUI(0);
      } else {
        // let list handlers clear
        clearAllSearchInputs();
        const ev = new Event('input', {bubbles:true});
        // dispatch to the original search input so welcome.js handlers pick it up
        if(searchInput) searchInput.dispatchEvent(ev);
      }
    }));

    // wire input on the original list-search as well (keeps list handlers working)
    let searchTimer = null;
    if(searchInput){
      searchInput.addEventListener('input', function(e){
        const q = e.target.value || '';
        clearTimeout(searchTimer);
        searchTimer = setTimeout(async ()=>{
          if(document.body.dataset.resultMode === 'images'){
            await doImageSearch(q);
          } else {
            // Let existing welcome.js handle tag index search; dispatch input event so its debounced handler runs
            const ev = new Event('input', { bubbles: true });
            e.target.dispatchEvent(ev);
          }
        }, 220);
      });
    }

  // initialize default to list view
  setMode('list');

    // When a tag-kind toggle inside the original controls changes, re-run image search when active
    try{
      const kindToggles = Array.from(document.querySelectorAll('#list-controls .tag-toggle'));
      kindToggles.forEach(t => {
        t.addEventListener('click', async ()=>{ if(document.body.dataset.resultMode === 'images'){ await doImageSearch(searchInput ? searchInput.value : ''); } });
        const cb = t.querySelector('input[type="checkbox"]');
        if(cb) cb.addEventListener('change', async ()=>{ if(document.body.dataset.resultMode === 'images'){ await doImageSearch(searchInput ? searchInput.value : ''); } });
      });
    }catch(e){}
  })();
  </script>
  <script>
    // Wire the main-nav to existing controls: explore -> gallery, search -> focus search, list -> list view
    (function(){
      const nav = document.querySelector('.main-nav');
      if(!nav) return;
      const items = nav.querySelectorAll('.nav-item');
      function setActive(action){ items.forEach(i=> i.classList.toggle('active', i.dataset.action===action)); }
      nav.addEventListener('click', (e)=>{
        const a = e.target.closest('.nav-item'); if(!a) return; e.preventDefault();
        const action = a.dataset.action; setActive(action);
        if(action === 'explore'){
          const btn = document.getElementById('btn-gallery'); if(btn) btn.click();
          document.getElementById('infinite-gallery').style.display='grid';
          document.getElementById('list-view').style.display='none';
        } else if(action === 'search'){
          // The nav's Search now opens the List view (was previously the List button)
          const btn = document.getElementById('btn-list'); if(btn) btn.click();
          // Scroll to top of page
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } else if(action === 'about'){
          // Open the in-page About sliding panel instead of navigating away
          const panel = document.getElementById('about-panel');
          if(panel){
            panel.classList.add('open');
            panel.setAttribute('aria-hidden','false');
            // move focus to close button for accessibility
            const closeBtn = panel.querySelector('.about-close');
            if(closeBtn) closeBtn.focus();
            document.body.classList.add('about-open');
          }
        }
      });
    })();
  </script>
  <script>
    // About panel open/close behavior
    (function(){
      const panel = document.getElementById('about-panel');
      if(!panel) return;
      const closeBtn = panel.querySelector('.about-close');
      function closeAbout(){ panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); document.body.classList.remove('about-open'); }
      closeBtn && closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeAbout(); });
      // click on backdrop (panel but outside inner) closes
      panel.addEventListener('click', (e)=>{ if(e.target === panel) closeAbout(); });
      // Escape key to close
      window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && panel.classList.contains('open')) closeAbout(); });
      // also close when switching away via nav: if nav sets other active state, hide panel
      const nav = document.querySelector('.main-nav');
      if(nav){ nav.addEventListener('click', (ev)=>{ const a = ev.target.closest('.nav-item'); if(!a) return; const action = a.dataset.action; if(action !== 'about' && panel.classList.contains('open')) closeAbout(); }); }
    })();
  </script>
  <script>
  (function(){
    const brand = document.querySelector('.site-brand');
    if(!brand) return;

    // Split brand text into per-character spans (preserve <br> nodes)
    function splitBrandChars(el){
      const nodes = Array.from(el.childNodes);
      el.innerHTML = '';
      nodes.forEach(n => {
        if(n.nodeType === Node.ELEMENT_NODE && n.tagName === 'BR'){
          el.appendChild(document.createElement('br'));
          return;
        }
        const text = n.textContent || '';
        for(let ch of text){
          const span = document.createElement('span');
          span.className = 'brand-char';
          // convert plain spaces to non-breaking spaces so they keep a visible gap
          // when each character is wrapped in inline-block spans.
          if (ch === ' ') span.textContent = '\u00A0'; else span.textContent = ch;
          el.appendChild(span);
        }
      });
    }

    splitBrandChars(brand);

  const chars = Array.from(brand.querySelectorAll('.brand-char'));
  const imageSelectors = '#infinite-gallery img, #infinite-gallery .card';

    function rectsOverlap(a,b){ return !(b.left > a.right || b.right < a.left || b.top > a.bottom || b.bottom < a.top); }

    function checkOverlap(){
      try{
        const imgs = Array.from(document.querySelectorAll(imageSelectors));
        // filter to visible images to speed up check
        const visibleImgs = imgs.filter(img => {
          const r = img.getBoundingClientRect();
          return !(r.bottom < 0 || r.top > (window.innerHeight||document.documentElement.clientHeight));
        }).map(i=>i.getBoundingClientRect());

        if(visibleImgs.length === 0){
          // no images in viewport -> ensure chars are in default state
          chars.forEach(c => c.classList.remove('overlap'));
          return;
        }

        chars.forEach(c => {
          const r = c.getBoundingClientRect();
          let overlapped = false;
          for(let im of visibleImgs){ if(rectsOverlap(r, im)){ overlapped = true; break; } }
          c.classList.toggle('overlap', overlapped);
        });
      }catch(e){ console.warn('brand overlap check failed', e); }
    }

  // use requestAnimationFrame to schedule checks for smoother, immediate response
  let scheduled = false;
  function scheduleCheck(){ if(scheduled) return; scheduled = true; requestAnimationFrame(()=>{ scheduled = false; checkOverlap(); }); }
  ['scroll','resize','load','orientationchange'].forEach(ev => window.addEventListener(ev, scheduleCheck, {passive:true}));
  document.addEventListener('DOMContentLoaded', scheduleCheck);
  const gallery = document.getElementById('infinite-gallery');
  if(gallery){ const mo = new MutationObserver(scheduleCheck); mo.observe(gallery, { childList:true, subtree:true, attributes:true }); }
  // run once after layout
  requestAnimationFrame(checkOverlap);
  })();
  </script>
  <script>
  // Build search tags dynamically from protest_data.json
  (function(){
    const DATA_URL = 'protest_data.json';
    const TARGET_SELECTOR = '#list-grid .tags';

    function textCase(str){
      if(!str) return '';
      return String(str).trim();
    }

    function mkSpan(kind, value){
      const s = document.createElement('span');
      s.className = `tag ${kind} clickable-tag`;
      s.dataset.kind = kind;
      s.dataset.value = value;
      s.textContent = textCase(value);
      return s;
    }

    async function buildTags(){
      const containers = Array.from(document.querySelectorAll(TARGET_SELECTOR));
      if(!containers.length) return;
      let data;
      try{
        const res = await fetch(DATA_URL, {cache: 'no-store'});
        data = await res.json();
      }catch(e){
        console.warn('Could not load', DATA_URL, e);
        return;
      }

      // collect unique values
      const sets = {
        country: new Set(),
        cause: new Set(),
        type: new Set(),
        name: new Set(),
        protest: new Set(),
        timeframe: new Set()
      };

      (data || []).forEach(item => {
        if(!item || typeof item !== 'object') return;
        if(item.name) sets.name.add(item.name);

        const add = (key, set) => {
          const v = item[key];
          if(!v) return;
          if(Array.isArray(v)) v.forEach(x => x && set.add(String(x)));
          else if(typeof v === 'string') set.add(v);
        };

        // try common property names
        add('categories_country', sets.country);
        add('categories_cause', sets.cause);
        add('categories_object_type', sets.type);
        add('categories_timeframe', sets.timeframe);
        add('categories_protest', sets.protest);
        // legacy / alternate keys
        add('countries', sets.country);
        add('causes', sets.cause);
        add('object_type', sets.type);
      });

      // render into each container
      const order = ['cause','country','type','name','protest','timeframe'];
      containers.forEach(container => {
        container.innerHTML = '';
        order.forEach(kind => {
          const arr = Array.from(sets[kind] || []).sort((a,b)=> a.localeCompare(b, undefined, {sensitivity:'base'}));
          arr.forEach(v => container.appendChild(mkSpan(kind, v)));
        });
      });
    }

    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', buildTags);
    else buildTags();
    window.refreshSearchTags = buildTags;
  })();
  </script>

</body>
</html>
